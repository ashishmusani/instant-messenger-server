(this["webpackJsonprealtime-chat-app"]=this["webpackJsonprealtime-chat-app"]||[]).push([[0],{115:function(e,n){},118:function(e,n){function a(e){var n=new Error("Cannot find module '"+e+"'");throw n.code="MODULE_NOT_FOUND",n}a.keys=function(){return[]},a.resolve=a,e.exports=a,a.id=118},119:function(e,n,a){},120:function(e,n,a){},121:function(e,n,a){},141:function(e,n,a){},142:function(e,n,a){},144:function(e,n,a){"use strict";a.r(n);var t=a(0),l=a.n(t),c=a(21),o=a.n(c),r=a(14),s=a(10),i=a(75),u=a.n(i),m=a(41),d=a(76),g=a.n(d),f=(a(119),a(120),a(8));function _(e){var n=e.envelope,a=n.sender,t=n.message,c=n.type;return l.a.createElement("div",null,"Me"===a?l.a.createElement(f.a,{xs:"2"}):null,l.a.createElement("div",{className:"Me"===a?"single-message__self":"single-message__other"},l.a.createElement("small",null,l.a.createElement("strong",null,a)),l.a.createElement("div",{className:"single-message__content"},"image"===c?l.a.createElement("img",{className:"single-message__image",src:t,alt:"Problem loading resource"}):t)))}a(121);function p(e){var n=e.user,a=e.setSendingTo,t=e.sendingTo,c=e.unreads,o=e.closeOnlineUsersModal;return l.a.createElement("div",{className:t===n?"online-user-selected":"online-user",onClick:function(){a(n),o()}},l.a.createElement("div",{className:"online-user__icon"}),l.a.createElement("div",{className:"online-user__details"},l.a.createElement("strong",null,n," ")),c>0?l.a.createElement("div",{className:"online-user__details__unreads"},c):null)}function v(e){var n=e.sendingTo,a=e.setSendingTo,t=e.onlineUsers;t=["conference"].concat(Object(m.a)(t));var c=e.unreadMessagesCount,o=e.closeOnlineUsersModal;return l.a.createElement("div",{className:"online-users-list"},t.map((function(e){return l.a.createElement(p,{user:e,unreads:c[e],sendingTo:n,setSendingTo:a,closeOnlineUsersModal:o})})))}var E=l.a.createContext(null),b=a(77),O=a(24),h=a(6),y=a(31),j=a(50),S=a(23),w=a(147),C=a(148),I=a(149),N=a(150),k=new Audio("/msg_notification.mp3"),T=new Audio("/call_notification.mp3"),M=new Audio("/call_drop_notification.mp3"),L=new Audio("/ringing_tone.mp3");T.loop=!0,L.loop=!0;var U,x,A=new g.a(void 0,{secure:!0}),J={isInCall:!1,callType:null,callStatus:null,isInCallWith:null,peerIdToCall:null};function D(e,n){switch(n.type){case"outgoing-call":return{isInCall:!0,callType:"outgoing",callStatus:"ringing",isInCallWith:n.calling_to};case"outgoing-call__answered":return Object(r.a)(Object(r.a)({},e),{},{callStatus:"connected"});case"outgoing-call__declined":return{};case"incoming-call":return{isInCall:!0,callType:"incoming",callStatus:"ringing",isInCallWith:n.call_from,peerIdToCall:n.callee_peerId};case"incoming-call__answered":return Object(r.a)(Object(r.a)({},e),{},{callStatus:"connected"});case"incoming-call__declined":return{};case"call__ended":return Object(r.a)({},J);default:throw new Error}}function F(e){var n=Object(t.useContext)(E).username,a=e.socket,c=e.handleLogout,o=Object(t.useRef)(null),i=Object(t.useRef)(null),u=Object(t.useRef)(null),d=Object(t.useRef)(null),g=Object(t.useState)([]),p=Object(s.a)(g,2),F=p[0],B=p[1],R=Object(t.useState)({}),P=Object(s.a)(R,2),W=P[0],q=P[1],z=Object(t.useState)({}),G=Object(s.a)(z,2),V=G[0],H=G[1],$=Object(t.useState)(""),K=Object(s.a)($,2),Q=K[0],X=K[1],Y=Object(t.useState)("conference"),Z=Object(s.a)(Y,2),ee=Z[0],ne=Z[1],ae=Object(t.useState)(!1),te=Object(s.a)(ae,2),le=te[0],ce=te[1],oe=function(){return ce(!1)},re=Object(t.useReducer)(D,J),se=Object(s.a)(re,2),ie=se[0],ue=se[1];function me(e,n){var a;if((a="outgoing"===e?n.to:n.isBroadcast?"conference":n.sender)in W&&W[a].length>0){var t=[].concat(Object(m.a)(W[a]),[n]),l=Object(r.a)({},W);l[a]=t,q(l)}else{var c=[n],o=Object(r.a)({},W);o[a]=c,q(o)}}function de(e){var n;if((n=e.isBroadcast?"conference":e.sender)!==ee)if(n in V){var a=V;a[n]=a[n]+1,H(a)}else{var t=V;t[n]=1,H(t)}}function ge(e){switch(_e(),M.play(),console.log("ending "+ie.callType+" call"),A.removeAllListeners(),e&&a.emit("end_ongoing_call",ie.isInCallWith),ie.callStatus){case"connected":U.close();break;case"ringing":fe()}}function fe(){d.current.srcObject=null,x&&x.getTracks().forEach((function(e){return e.stop()})),ue({type:"call__ended"})}function _e(){T.pause(),T.currentTime=0,L.pause(),L.currentTime=0}return Object(t.useEffect)((function(){a.open(),a.emit("login",n);var e=JSON.parse(sessionStorage.getItem("conversation"));return e&&q(e),function(){a.disconnect()}}),[n,a]),Object(t.useEffect)((function(){o.current.scrollIntoView({block:"end"}),function(){var e=V;e[ee]=0,H(e)}()}),[ee,W]),Object(t.useEffect)((function(){sessionStorage.setItem("conversation",JSON.stringify(W))}),[W]),Object(t.useEffect)((function(){a.removeAllListeners("broadcast-to-clients"),a.removeAllListeners("online-users-list"),a.removeAllListeners("personal_message"),a.removeAllListeners("disconnect"),a.on("broadcast-to-clients",(function(e){k.play(),de(e),me("incoming",e)})),a.on("online-users-list",(function(e){B(e.filter((function(e){return e!==n})))})),a.on("personal_message",(function(e){k.play(),de(e),me("incoming",e)})),a.on("disconnect",(function(e){"io client disconnect"!==e&&(c(),alert("Disconnected from server"),a.connect())})),a.removeAllListeners("incoming_call_request"),a.on("incoming_call_request",(function(e,n){console.log("initiating call to peerId: "+e),T.play(),ue({type:"incoming-call",call_from:n,callee_peerId:e})})),a.removeAllListeners("end_ongoing_call"),a.on("end_ongoing_call",(function(){console.log("ending call due to socket event receipt"),ge()}))})),l.a.createElement(b.a,{fluid:!0,id:"chat-screen"},l.a.createElement(O.a,{id:"chat-screen__msg-area"},l.a.createElement(f.a,{xs:"3",sm:"3",id:"chat-screen__msg-area__online-users"},l.a.createElement(v,{onlineUsers:F,unreadMessagesCount:V,sendingTo:ee,setSendingTo:ne,closeOnlineUsersModal:oe})),l.a.createElement(f.a,{xs:"12",sm:"9",id:"chat-screen__msg-area__main"},l.a.createElement("div",{id:"chat-screen__msg-area__header"},l.a.createElement("span",{id:"chat-screen__msg-area__header__normal"},ee),l.a.createElement("span",{id:"chat-screen__msg-area__header__xs",onClick:function(){return ce(!0)}},ee),l.a.createElement(y.a,{show:le,onHide:oe,centered:!0},l.a.createElement(y.a.Header,{closeButton:!0},l.a.createElement(y.a.Title,null,"Online Users")),l.a.createElement(v,{onlineUsers:F,unreadMessagesCount:V,sendingTo:ee,setSendingTo:ne,closeOnlineUsersModal:oe}))),l.a.createElement("div",{className:"chat-screen__msg-area__conversation"},ee in W&&W[ee].length>0?W[ee].map((function(e){return l.a.createElement(_,{envelope:e})})):null,l.a.createElement(O.a,{className:"dummy-message",ref:o})),l.a.createElement("div",{className:"chat-screen__actions"},l.a.createElement(h.a,{onSubmit:function(e){return function(e){if(e.preventDefault(),""===Q)alert("Cant send blank");else{var t={sender:n,to:ee,type:"text",message:Q,isBroadcast:"conference"===ee};"conference"===ee?a.emit("broadcast-to-server",t):a.emit("personal_message",t),t.sender="Me",me("outgoing",t),X("")}}(e)}},l.a.createElement(h.a.Group,{as:f.a,sm:"12",controlId:"send_message"},l.a.createElement(j.a,null,l.a.createElement(h.a.Control,{id:"chat-screen__actions__message",ref:i,size:"md",type:"text",placeholder:"Type a message",value:Q,onChange:function(e){return X(e.target.value)},autocomplete:"off",autoFocus:!0}),l.a.createElement(j.a.Append,null,l.a.createElement(S.a,{variant:"secondary",onClick:function(){"conference"===ee?alert("Oops! Conference calls are not yet supported!"):(console.log("Placing audio call request"),L.play(),a.emit("make_call_request",A.id,ee,n),ue({type:"outgoing-call",calling_to:ee}),A.on("call",(function(e){console.log("call received from another user"),_e(),ue({type:"outgoing-call__answered"}),navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(n){x=n,U=e,e.answer(n),e.on("stream",(function(e){d.current.srcObject=e,console.log("Stream received from calling to user")})),U.on("close",(function(){console.log("on close() called for "+ie.callType),fe()}))}))})))}},l.a.createElement(w.a,null)),l.a.createElement(S.a,{variant:"secondary",onClick:function(){u.current.click()}},l.a.createElement(C.a,null)),l.a.createElement(h.a.File,{id:"chat-screen__actions__file",accept:"image/*",ref:u,onChange:function(e){return function(e){var t=e.target.files[0],l=new FileReader;l.readAsDataURL(t),l.onload=function(){var e=l.result,t={sender:n,to:ee,type:"image",message:e,isBroadcast:"conference"===ee};"conference"===ee?a.emit("broadcast-to-server",t):a.emit("personal_message",t),t.sender="Me",me("outgoing",t)}}(e)}})))))))),l.a.createElement("video",{className:"chat-screen__mediastream",autoplay:"true",id:"mediaDiv",ref:d}),l.a.createElement(y.a,{id:"call_modal",show:ie.isInCall,centered:!0},l.a.createElement("div",{className:"call_profile"},l.a.createElement("div",{className:"call_profile_photo"}),l.a.createElement("div",{className:"call_profile_name"},ie.isInCallWith)),l.a.createElement("div",{className:"call_actions"},"incoming"===ie.callType&&"ringing"===ie.callStatus?l.a.createElement(l.a.Fragment,null,l.a.createElement(I.a,{id:"call_answer_button",onClick:function(){return _e(),ue({type:"incoming-call__answered"}),void navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(e){x=e,(U=A.call(ie.peerIdToCall,e)).on("stream",(function(e){d.current.srcObject=e,console.log("stream received from call initiator user")})),U.on("close",(function(){console.log("on close() called for "+ie.callType),fe()}))}))}}),l.a.createElement(N.a,{id:"call_end_button",onClick:function(){return ge(!0)}})):l.a.createElement(N.a,{id:"call_end_button",onClick:function(){return ge(!0)}}))))}var B=a(78),R=a.n(B);a(141);function P(){var e=Object(t.useContext)(E),n=Object(t.useState)(!1),a=Object(s.a)(n,2),c=a[0],o=a[1],r=Object(t.useState)(""),i=Object(s.a)(r,2),u=i[0],m=i[1],d=Object(t.useState)(""),g=Object(s.a)(d,2),_=g[0],p=g[1];return l.a.createElement(h.a,{className:"login-form",noValidate:!0,validated:c,onSubmit:function(n){if(n.preventDefault(),!1===n.currentTarget.checkValidity())n.stopPropagation(),o(!0);else{var a={username:u,password:_};R.a.post("".concat(window.location.href,"login"),a).then((function(n){201===n.status&&(sessionStorage.setItem("username",JSON.stringify(u)),sessionStorage.setItem("loggedIn",JSON.stringify(!0)),e.dispatch({type:"login",username:u}))})).catch((function(e){e&&(e.response&&401===e.response.status?alert(e.response.data):alert(e))}))}}},l.a.createElement(h.a.Group,{as:O.a,className:"justify-content-center",controlId:"validate_login_username"},l.a.createElement(f.a,{sm:"2",md:"1"},l.a.createElement(h.a.Label,null,"Username")),l.a.createElement(f.a,{sm:"4",md:"4"},l.a.createElement(h.a.Control,{type:"text",size:"sm",value:u,onChange:function(e){return m(e.target.value)},required:!0,autocomplete:"off",autoFocus:!0}),l.a.createElement(h.a.Control.Feedback,{type:"invalid"},"Please provide username"))),l.a.createElement(h.a.Group,{as:O.a,className:"justify-content-center",controlId:"validate_login_password"},l.a.createElement(f.a,{sm:"2",md:"1"},l.a.createElement(h.a.Label,null,"Password")),l.a.createElement(f.a,{sm:"4",md:"4"},l.a.createElement(h.a.Control,{type:"password",size:"sm",value:_,onChange:function(e){return p(e.target.value)},required:!0}),l.a.createElement(h.a.Control.Feedback,{type:"invalid"},"Please provide password"))),l.a.createElement(h.a.Group,{as:O.a,className:"justify-content-center"},l.a.createElement(f.a,{sm:"4",md:"4"}),l.a.createElement(f.a,{sm:"2",md:"1"},l.a.createElement(S.a,{className:"btn-block",type:"submit"},"Login"))))}a(142);var W=a(51),q=a(79),z=u()({secure:!0});function G(e,n){switch(n.type){case"login":return{loggedIn:!0,username:n.username};case"logout":return{loggedIn:!1,username:null};default:throw new Error}}var V=function(){var e=Object(t.useReducer)(G,{username:JSON.parse(sessionStorage.getItem("username"))||"",loggedIn:JSON.parse(sessionStorage.getItem("loggedIn"))||!1}),n=Object(s.a)(e,2),a=n[0],c=n[1],o=function(){sessionStorage.setItem("username",JSON.stringify(null)),sessionStorage.setItem("loggedIn",JSON.stringify(!1)),z.connected&&z.close(),c({type:"logout"})},i=Object(r.a)(Object(r.a)({},a),{},{dispatch:c});return l.a.createElement(E.Provider,{value:i},l.a.createElement(W.a,{className:"header",expand:"lg",sticky:"top"},l.a.createElement(W.a.Brand,null,"Instant Messenger"),!0===a.loggedIn?l.a.createElement(l.a.Fragment,null,l.a.createElement(q.a,{className:"ml-auto"},l.a.createElement(S.a,{variant:"outline-secondary",size:"sm",onClick:o},"Logout"))):null),!0===a.loggedIn?l.a.createElement(F,{handleLogout:o,socket:z}):l.a.createElement(P,null))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));a(143);o.a.render(l.a.createElement(l.a.StrictMode,null,l.a.createElement(V,null)),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))},80:function(e,n,a){e.exports=a(144)}},[[80,1,2]]]);
//# sourceMappingURL=main.74835416.chunk.js.map